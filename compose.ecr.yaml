# Docker Compose ECRç’°å¢ƒç”¨
# ä½¿ç”¨æ–¹æ³•: docker compose -f compose.ecr.yaml --env-file .env.stg up -d
#
# ECRã‹ã‚‰ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ã—ã¦ä½¿ç”¨
# å¿…è¦ãªç’°å¢ƒå¤‰æ•°:
#   ECR_REGISTRY: ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªURL (ä¾‹: 123456789012.dkr.ecr.ap-northeast-1.amazonaws.com)
#   IMAGE_TAG: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (ä¾‹: stg, prod, abc1234)

services:
  redis:
    image: redis:7-alpine
    container_name: fz99-lounge-redis
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - fz99-lounge-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    image: ${ECR_REGISTRY}/fz99-lounge-api:${IMAGE_TAG:-stg}
    container_name: fz99-lounge-api
    restart: always
    environment:
      NODE_ENV: production
      PORT: ${API_PORT:-3000}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET}
      DISCORD_CALLBACK_URL: ${DISCORD_CALLBACK_URL}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID}
      DISCORD_MATCH_ROOM_CATEGORY_ID: ${DISCORD_MATCH_ROOM_CATEGORY_ID}
      DISCORD_BOT_ENABLED: ${DISCORD_BOT_ENABLED:-true}
      DISCORD_MATCH_ANNOUNCE_CHANNEL_ID: ${DISCORD_MATCH_ANNOUNCE_CHANNEL_ID}
      DISCORD_MATCH_NOTIFY_ROLE_ID: ${DISCORD_MATCH_NOTIFY_ROLE_ID}
      DISCORD_REACTION_ROLE_CHANNEL_ID: ${DISCORD_REACTION_ROLE_CHANNEL_ID}
      DISCORD_REACTION_ROLE_MESSAGE_ID: ${DISCORD_REACTION_ROLE_MESSAGE_ID}
      DISCORD_REACTION_ROLE_EMOJI: ${DISCORD_REACTION_ROLE_EMOJI:-ðŸ””}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}
      ENABLE_LOGIN_TRACKING: ${ENABLE_LOGIN_TRACKING:-true}
      MULTI_ACCOUNT_IP_THRESHOLD: ${MULTI_ACCOUNT_IP_THRESHOLD:-2}
      SUSPICIOUS_LOGIN_ALERT_DAYS: ${SUSPICIOUS_LOGIN_ALERT_DAYS:-30}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      S3_REGION: ${S3_REGION:-ap-northeast-1}
      S3_ENDPOINT: ""
      S3_ACCESS_KEY_ID: ""
      S3_SECRET_ACCESS_KEY: ""
      CDN_URL: ${CDN_URL:-}
      NODE_OPTIONS: "--max-old-space-size=1024"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - fz99-lounge-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => r.statusCode === 200 ? process.exit(0) : process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  web:
    image: ${ECR_REGISTRY}/fz99-lounge-web:${IMAGE_TAG:-stg}
    container_name: fz99-lounge-web
    restart: always
    environment:
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=1024"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - fz99-lounge-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"

  nginx:
    image: nginx:alpine
    container_name: fz99-lounge-nginx
    restart: always
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/aws.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_cache:/var/cache/nginx
    ports:
      - "80:80"
    depends_on:
      - api
      - web
    networks:
      - fz99-lounge-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  fz99-lounge-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  nginx_cache:
    driver: local
